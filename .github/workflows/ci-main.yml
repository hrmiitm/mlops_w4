name: CI Pipeline - Main Branch

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-train-and-push:
    runs-on: ubuntu-latest
    permissions:                    # ← ADD THIS SECTION
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ... rest of your steps remain the same

      - name: Set up Python
        uses: actions/setup-python@v5   # Updated to latest
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v4   # Updated to v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure DVC remote
        run: |
          dvc remote modify myremote credentialpath /tmp/gcp-key.json || true
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-key.json

      - name: Pull data and model from DVC
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
          dvc pull || echo "No remote data to pull, continuing..."

      - name: Run data validation tests
        run: |
          pytest tests/test_data_validation.py -v --tb=short

      - name: Run DVC pipeline
        run: |
          dvc repro

      - name: Run evaluation tests
        run: |
          pytest tests/test_eval.py -v --tb=short

      - name: Push model to DVC
        if: github.event_name == 'push'
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
          dvc push

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Generate CML Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# 🚀 Model Evaluation Report - Main Branch" > report.md
          echo "" >> report.md
          echo "## 📊 Model Performance Metrics" >> report.md
          echo "" >> report.md
          
          if [ -f models/metrics.json ]; then
            echo "### Training Metrics" >> report.md
            echo "\`\`\`json" >> report.md
            cat models/metrics.json >> report.md
            echo "\`\`\`" >> report.md
            echo "" >> report.md
          fi
          
          if [ -f models/evaluation_report.json ]; then
            echo "### Evaluation Metrics" >> report.md
            echo "\`\`\`json" >> report.md
            cat models/evaluation_report.json >> report.md
            echo "\`\`\`" >> report.md
            echo "" >> report.md
          fi
          
          echo "## ✅ Production Deployment Status" >> report.md
          echo "Model successfully trained and pushed to DVC remote!" >> report.md
          echo "" >> report.md
          echo "**Branch:** \`main\`" >> report.md
          echo "**Commit:** \`${{ github.sha }}\`" >> report.md
          echo "**Deployed by:** @${{ github.actor }}" >> report.md
          
          cml comment create report.md

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-main
          path: |
            models/
            !models/.gitkeep

